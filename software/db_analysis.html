<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How to use DB (tips, tricks and more) | BRAIN CoGS mini VR rigs</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Documentation for virtual reality rigs at Princeton BRAIN CoGS project">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.6e54da3e.css" as="style"><link rel="preload" href="/assets/js/app.2e1d0086.js" as="script"><link rel="preload" href="/assets/js/2.f73e3e1e.js" as="script"><link rel="preload" href="/assets/js/1.c51b9512.js" as="script"><link rel="preload" href="/assets/js/31.e245e83a.js" as="script"><link rel="prefetch" href="/assets/js/10.28ab9cf5.js"><link rel="prefetch" href="/assets/js/11.b8e01274.js"><link rel="prefetch" href="/assets/js/12.01f9d7cf.js"><link rel="prefetch" href="/assets/js/13.3e4bb9d9.js"><link rel="prefetch" href="/assets/js/14.4280d58e.js"><link rel="prefetch" href="/assets/js/15.c2481de1.js"><link rel="prefetch" href="/assets/js/16.0d27a42c.js"><link rel="prefetch" href="/assets/js/17.bf76a0f7.js"><link rel="prefetch" href="/assets/js/18.219da49e.js"><link rel="prefetch" href="/assets/js/19.8e1d46db.js"><link rel="prefetch" href="/assets/js/20.aa1d6fa3.js"><link rel="prefetch" href="/assets/js/21.1931c23e.js"><link rel="prefetch" href="/assets/js/22.796e9949.js"><link rel="prefetch" href="/assets/js/23.cc03e5ad.js"><link rel="prefetch" href="/assets/js/24.f1842dd7.js"><link rel="prefetch" href="/assets/js/25.1cc0ff2e.js"><link rel="prefetch" href="/assets/js/26.bf610798.js"><link rel="prefetch" href="/assets/js/27.34d9178c.js"><link rel="prefetch" href="/assets/js/28.27e8c12c.js"><link rel="prefetch" href="/assets/js/29.13b12301.js"><link rel="prefetch" href="/assets/js/3.e8951f3a.js"><link rel="prefetch" href="/assets/js/30.75a380a5.js"><link rel="prefetch" href="/assets/js/32.9fca9676.js"><link rel="prefetch" href="/assets/js/33.0e3bba28.js"><link rel="prefetch" href="/assets/js/34.220cdeed.js"><link rel="prefetch" href="/assets/js/35.ecdec2a2.js"><link rel="prefetch" href="/assets/js/36.758a67d9.js"><link rel="prefetch" href="/assets/js/37.f2b19388.js"><link rel="prefetch" href="/assets/js/38.ddeff521.js"><link rel="prefetch" href="/assets/js/39.dd78eec6.js"><link rel="prefetch" href="/assets/js/4.8d93e77a.js"><link rel="prefetch" href="/assets/js/40.080bf08b.js"><link rel="prefetch" href="/assets/js/41.b5e0bbd1.js"><link rel="prefetch" href="/assets/js/42.8fd55afd.js"><link rel="prefetch" href="/assets/js/43.836fbed0.js"><link rel="prefetch" href="/assets/js/44.7558313c.js"><link rel="prefetch" href="/assets/js/45.98c02387.js"><link rel="prefetch" href="/assets/js/46.f7863950.js"><link rel="prefetch" href="/assets/js/47.58ee2c27.js"><link rel="prefetch" href="/assets/js/48.baf53650.js"><link rel="prefetch" href="/assets/js/49.5a74915a.js"><link rel="prefetch" href="/assets/js/5.6ffcefef.js"><link rel="prefetch" href="/assets/js/50.557a1eb8.js"><link rel="prefetch" href="/assets/js/51.6351139d.js"><link rel="prefetch" href="/assets/js/52.9cb0c7c8.js"><link rel="prefetch" href="/assets/js/6.f914edf2.js"><link rel="prefetch" href="/assets/js/7.ea5c102c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d116d088.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6e54da3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BRAIN CoGS mini VR rigs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/building/" class="nav-link">
  Building
</a></div><div class="nav-item"><a href="/maintenance/" class="nav-link">
  Maintenance
</a></div><div class="nav-item"><a href="/software/" class="nav-link router-link-active">
  Software
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/building/" class="nav-link">
  Building
</a></div><div class="nav-item"><a href="/maintenance/" class="nav-link">
  Maintenance
</a></div><div class="nav-item"><a href="/software/" class="nav-link router-link-active">
  Software
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/software/" aria-current="page" class="sidebar-link">Software</a></li><li><a href="/software/db_access.html" class="sidebar-link">Database Access</a></li><li><a href="/software/db_organization.html" class="sidebar-link">Database Organization</a></li><li><a href="/software/db_analysis.html" aria-current="page" class="active sidebar-link">How to use DB (tips, tricks and more)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/software/db_analysis.html#matlab" class="sidebar-link">MATLAB</a></li><li class="sidebar-sub-header"><a href="/software/db_analysis.html#python" class="sidebar-link">PYTHON</a></li></ul></li><li><a href="/software/virmen_guide.html" class="sidebar-link">ViRMEn User/Developer Guide</a></li><li><a href="/software/automation_pipeline.html" class="sidebar-link">Ephys/Imaging Automation Pipeline</a></li><li><a href="/software/automated_cronjobs.html" class="sidebar-link">Automated cronjobs in BRAINCoGS (Developer Guide)</a></li><li><a href="/software/automation_pipeline_developer.html" class="sidebar-link">Ephys/Imaging Automation Pipeline in BRAINCoGS (Developer Guide)</a></li><li><a href="/software/configure_systems.html" class="sidebar-link">Configure behavior &amp; recording systems</a></li><li><a href="/software/alert_system.html" class="sidebar-link">Configure custom slack alerts</a></li><li><a href="/software/manipulation_pipeline.html" class="sidebar-link">Manipulation pipeline</a></li><li><a href="/software/pupillometry_guide.html" class="sidebar-link">Pupillometry Pipeline Guide</a></li><li><a href="/software/subtask_pipeline.html" class="sidebar-link">Subtask pipeline</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="frontmatter-title"><a href="#frontmatter-title" class="header-anchor">#</a> How to use DB (tips, tricks and more)</h1> <h2 id="matlab"><a href="#matlab" class="header-anchor">#</a> MATLAB</h2> <h3 id="prerequesites"><a href="#prerequesites" class="header-anchor">#</a> Prerequesites</h3> <ol><li>U19-pipeline-matlab repo added to MATLAB path</li> <li>Mounted network cup drives (braininit, u19_dj)</li></ol> <ul><li>Check (see <a href="https://braincogs.github.io/software/db_access.html">Database access section</a> ) for more info.</li></ul> <h3 id="recommended-tutorial"><a href="#recommended-tutorial" class="header-anchor">#</a> Recommended tutorial</h3> <ul><li>Go through <code>U19-pipeline-matlab/tutorials/202103/session01_queries_fetches.mlx</code> to learn basic tips on datajoint.</li></ul> <h3 id="useful-scripts-and-functions-for-reseacher-general-use"><a href="#useful-scripts-and-functions-for-reseacher-general-use" class="header-anchor">#</a> <strong>Useful scripts and functions</strong> for reseacher general use:</h3> <h3 id="read-behavior-file"><a href="#read-behavior-file" class="header-anchor">#</a> Read behavior file:</h3> <ol><li>Execute: (change key for desired session)</li></ol> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
[status,data] = lab.utils.read_behavior_file(key)
</code></pre></div><ol start="2"><li>If successful <code>status = 1</code> and <code>data = log behavioral file</code></li></ol> <h3 id="get-behavior-file-location-local-for-spock-scotty"><a href="#get-behavior-file-location-local-for-spock-scotty" class="header-anchor">#</a> Get behavior file location (local &amp; for spock/scotty)</h3> <ol><li>If you only need to know the path of behavior file use:</li></ol> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
baseDir = fetch1(acquisition.SessionStarted &amp; key, 'new_remote_path_behavior_file');
[bucket_path, local_path] =  lab.utils.get_path_from_official_dir(baseDir)
</code></pre></div><h3 id="get-full-trial-data-with-spatialtimeblobs"><a href="#get-full-trial-data-with-spatialtimeblobs" class="header-anchor">#</a> get_full_trial_data with SpatialTimeBlobs</h3> <ul><li>Get trial data (position, velocity, etc) efficiently with DB.</li> <li>New method to retrieve all trial data for multiple sessions faster.</li></ul> <ol><li>Execute:</li></ol> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
get_full_trial_data(key)
</code></pre></div><ul><li>Get trial data from joined tables as well (e.g. <strong>TowersBlock</strong>):</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
get_full_trial_data(key, behavior.TowersBlockTrial * behavior.TowersBlock)
</code></pre></div><ul><li>Get data from subtasks as well (e.g. <strong>Twolickspouts</strong> subtask)</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'efonseca_ef114_act114', 'session_date', '2023-01-11');
all_tables = behavior.TowersBlockTrial * behavior.TowersBlock * behavior_subtask.TwolickspoutsBlockTrial * behavior_subtask.TwolickspoutsBlock
get_full_trial_data(key, all_tables)
</code></pre></div><h3 id="get-stats-from-session"><a href="#get-stats-from-session" class="header-anchor">#</a> get stats from session</h3> <ul><li>To get behavior file like stats (on the trial level) for a single or multiple sessions use this function</li> <li>Stats include, but not limited to: (<code>correct_left, correct_right, cum_correct_trials, performance, goodFraction, numPerMin, numRewardsPerMin, bias</code>)</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
stat_struct = get_stats_from_session(key, &quot;all&quot;)
</code></pre></div><h3 id="get-behaviorfile-as-db"><a href="#get-behaviorfile-as-db" class="header-anchor">#</a> get behaviorfile as db</h3> <ul><li>Function to unnest behavior file structure to get a plain trial table (with block data merged).</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
data_struct = get_behaviorfile_as_db(key)
</code></pre></div><h3 id="get-time-from-iteration-variable"><a href="#get-time-from-iteration-variable" class="header-anchor">#</a> get time from iteration variable</h3> <ul><li>Example of how to &quot;translate&quot; a variable from iteration# to trial_time</li> <li>In this case, 1st row of variable licks (iteration#) is translated to lick_times and then added to original trial structure</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'efonseca_ef114_act114', 'session_date', '2023-01-11');
trial_data = get_full_trial_data(key, behavior.TowersBlockTrial * behavior_subtask.TwolickspoutsBlockTrial);
licks_time_struct = struct;
for i=1:length(trial_data)
   licks_time_struct(i,1).lick_times = get_time_from_iter(trial_data(i).trial_time, trial_data(i).licks(1,:));
end
trial_data = cat_struct(trial_data, licks_time_struct);
</code></pre></div><h3 id="plot-framerate-frequency-sessions"><a href="#plot-framerate-frequency-sessions" class="header-anchor">#</a> plot framerate frequency sessions</h3> <ul><li>Plot trial by trial framerate of multiple sessions for comparison</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = 'subject_fullname like &quot;mioffe%&quot; and session_date &gt; &quot;2022-01-01&quot; and session_date &lt; &quot;2022-01-30&quot;';
analyze_iteration_time(key)
</code></pre></div> <figure><img src="/assets/img/plot_frequency_sessions1.6ea83bcc.png"> <center><figcaption>Framerate trial by trial sessions</figcaption></center></figure> <h3 id="plot-framerate-frequency-levels-and-rigs"><a href="#plot-framerate-frequency-levels-and-rigs" class="header-anchor">#</a> plot framerate frequency levels and rigs</h3> <ul><li>Plot mean framerate by level and rig for multiple sessions</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = 'subject_fullname like &quot;mioffe%&quot; and session_date &gt; &quot;2022-01-01&quot; and session_date &lt; &quot;2022-12-10&quot;';
analyze_iteration_time_level_rig(key)
</code></pre></div> <figure><img src="/assets/img/plot_frequency_sessions2.302da2bb.png"> <center><figcaption>Mean framerate by level and rig </figcaption></center></figure> <h3 id="plot-velocity-sessions"><a href="#plot-velocity-sessions" class="header-anchor">#</a> plot velocity sessions</h3> <ul><li>Plot mean - max range velocity by session for multiple behavior sessions</li></ul> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'emdiamanti_gps7');
plot_velocity_session(key)
</code></pre></div> <figure><img src="/assets/img/velocity_subject.0e563aaf.png"> <center><figcaption>Velocity plot for multiple sessions</figcaption></center></figure> <h3 id="get-path-table"><a href="#get-path-table" class="header-anchor">#</a> get path table</h3> <ol><li>Get default paths for network cup drives for different OS and spock/scotty (bucket)</li></ol> <div class="language- extra-class"><pre class="language-text"><code>key = struct('subject_fullname', 'testuser_T06', 'session_date', '2022-04-20');
baseDir = fetch1(acquisition.SessionStarted &amp; key, 'new_remote_path_behavior_file');
[bucket_path, local_path] =  lab.utils.get_path_from_official_dir(baseDir)
</code></pre></div> <figure><img src="/assets/img/path_table.8564e498.png"> <center><figcaption>Path table data</figcaption></center></figure> <h3 id="common-errors-and-troubleshooting"><a href="#common-errors-and-troubleshooting" class="header-anchor">#</a> Common errors and troubleshooting</h3> <ol><li>When trying to fetch from a table with external storage and corresponding network cup drive is not mounted:</li></ol> <div class="language- extra-class"><pre class="language-text"><code>Error using dj.store_plugins.File (line 89)
Directory `/Volumes/u19_dj/external_dj_blobs` not accessible.

Error in dj.internal.ExternalTable (line 52)
           self.spec = dj.store_plugins.(storePlugin)(config);
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>Error using fread
Invalid file identifier. Use fopen to generate a valid file identifier.

Error in dj.store_plugins.File.download_buffer (line 63)
           result = fread(fileID);
</code></pre></div><ul><li>Just mount all cup drives and try agian !!</li></ul> <ol start="2"><li>key reference more than one session when function was supposed to work for single sessions</li></ol> <div class="language- extra-class"><pre class="language-text"><code>Error using dj.internal.GeneralRelvar/fetch1 (line 250)
fetch1 can only retrieve a single existing tuple.
</code></pre></div><ul><li>Just recreate key to reference a single session.</li></ul> <h2 id="python"><a href="#python" class="header-anchor">#</a> PYTHON</h2> <h3 id="common-errors-and-troubleshooting-2"><a href="#common-errors-and-troubleshooting-2" class="header-anchor">#</a> Common errors and troubleshooting</h3></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/software/db_organization.html" class="prev">
        Database Organization
      </a></span> <span class="next"><a href="/software/virmen_guide.html">
        ViRMEn User/Developer Guide
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2e1d0086.js" defer></script><script src="/assets/js/2.f73e3e1e.js" defer></script><script src="/assets/js/1.c51b9512.js" defer></script><script src="/assets/js/31.e245e83a.js" defer></script>
  </body>
</html>
