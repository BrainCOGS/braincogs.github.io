<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Control | BRAIN CoGS mini VR rigs</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Documentation for virtual reality rigs at Princeton BRAIN CoGS project">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.6e54da3e.css" as="style"><link rel="preload" href="/assets/js/app.2e1d0086.js" as="script"><link rel="preload" href="/assets/js/2.f73e3e1e.js" as="script"><link rel="preload" href="/assets/js/1.c51b9512.js" as="script"><link rel="preload" href="/assets/js/12.01f9d7cf.js" as="script"><link rel="prefetch" href="/assets/js/10.28ab9cf5.js"><link rel="prefetch" href="/assets/js/11.b8e01274.js"><link rel="prefetch" href="/assets/js/13.3e4bb9d9.js"><link rel="prefetch" href="/assets/js/14.4280d58e.js"><link rel="prefetch" href="/assets/js/15.c2481de1.js"><link rel="prefetch" href="/assets/js/16.0d27a42c.js"><link rel="prefetch" href="/assets/js/17.bf76a0f7.js"><link rel="prefetch" href="/assets/js/18.219da49e.js"><link rel="prefetch" href="/assets/js/19.8e1d46db.js"><link rel="prefetch" href="/assets/js/20.aa1d6fa3.js"><link rel="prefetch" href="/assets/js/21.1931c23e.js"><link rel="prefetch" href="/assets/js/22.796e9949.js"><link rel="prefetch" href="/assets/js/23.cc03e5ad.js"><link rel="prefetch" href="/assets/js/24.f1842dd7.js"><link rel="prefetch" href="/assets/js/25.1cc0ff2e.js"><link rel="prefetch" href="/assets/js/26.bf610798.js"><link rel="prefetch" href="/assets/js/27.34d9178c.js"><link rel="prefetch" href="/assets/js/28.27e8c12c.js"><link rel="prefetch" href="/assets/js/29.13b12301.js"><link rel="prefetch" href="/assets/js/3.e8951f3a.js"><link rel="prefetch" href="/assets/js/30.75a380a5.js"><link rel="prefetch" href="/assets/js/31.e245e83a.js"><link rel="prefetch" href="/assets/js/32.9fca9676.js"><link rel="prefetch" href="/assets/js/33.0e3bba28.js"><link rel="prefetch" href="/assets/js/34.220cdeed.js"><link rel="prefetch" href="/assets/js/35.ecdec2a2.js"><link rel="prefetch" href="/assets/js/36.758a67d9.js"><link rel="prefetch" href="/assets/js/37.f2b19388.js"><link rel="prefetch" href="/assets/js/38.ddeff521.js"><link rel="prefetch" href="/assets/js/39.dd78eec6.js"><link rel="prefetch" href="/assets/js/4.8d93e77a.js"><link rel="prefetch" href="/assets/js/40.080bf08b.js"><link rel="prefetch" href="/assets/js/41.b5e0bbd1.js"><link rel="prefetch" href="/assets/js/42.8fd55afd.js"><link rel="prefetch" href="/assets/js/43.836fbed0.js"><link rel="prefetch" href="/assets/js/44.7558313c.js"><link rel="prefetch" href="/assets/js/45.98c02387.js"><link rel="prefetch" href="/assets/js/46.f7863950.js"><link rel="prefetch" href="/assets/js/47.58ee2c27.js"><link rel="prefetch" href="/assets/js/48.baf53650.js"><link rel="prefetch" href="/assets/js/49.5a74915a.js"><link rel="prefetch" href="/assets/js/5.6ffcefef.js"><link rel="prefetch" href="/assets/js/50.557a1eb8.js"><link rel="prefetch" href="/assets/js/51.6351139d.js"><link rel="prefetch" href="/assets/js/52.9cb0c7c8.js"><link rel="prefetch" href="/assets/js/6.f914edf2.js"><link rel="prefetch" href="/assets/js/7.ea5c102c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d116d088.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6e54da3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BRAIN CoGS mini VR rigs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/building/" class="nav-link router-link-active">
  Building
</a></div><div class="nav-item"><a href="/maintenance/" class="nav-link">
  Maintenance
</a></div><div class="nav-item"><a href="/software/" class="nav-link">
  Software
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/building/" class="nav-link router-link-active">
  Building
</a></div><div class="nav-item"><a href="/maintenance/" class="nav-link">
  Maintenance
</a></div><div class="nav-item"><a href="/software/" class="nav-link">
  Software
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/building/" aria-current="page" class="sidebar-link">Building a mini VR rig</a></li><li><a href="/building/cabinet.html" class="sidebar-link">Cabinet</a></li><li><a href="/building/stage.html" class="sidebar-link">Stage</a></li><li><a href="/building/air-supply.html" class="sidebar-link">Air supply</a></li><li><a href="/building/positioning.html" class="sidebar-link">Positioning</a></li><li><a href="/building/projection.html" class="sidebar-link">Projection</a></li><li><a href="/building/reward.html" class="sidebar-link">Reward</a></li><li><a href="/building/air-puffs.html" class="sidebar-link">Air puffs</a></li><li><a href="/building/control.html" aria-current="page" class="active sidebar-link">Control</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/building/control.html#solenoid-valve-driver-assembly" class="sidebar-link">Solenoid valve driver assembly</a></li><li class="sidebar-sub-header"><a href="/building/control.html#power-supply-and-nidaq-control-assembly" class="sidebar-link">Power supply and NIDAQ control assembly</a></li><li class="sidebar-sub-header"><a href="/building/control.html#arduino-module-assembly" class="sidebar-link">Arduino module assembly</a></li><li class="sidebar-sub-header"><a href="/building/control.html#programming-the-arduino" class="sidebar-link">Programming the Arduino</a></li><li class="sidebar-sub-header"><a href="/building/control.html#usb-hub-and-speaker" class="sidebar-link">USB HUB and Speaker</a></li></ul></li><li><a href="/building/pupillometry.html" class="sidebar-link">Pupillometry</a></li><li><a href="/building/lick-detection.html" class="sidebar-link">Lick detection</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="frontmatter-title"><a href="#frontmatter-title" class="header-anchor">#</a> Control</h1> <p>The control module consist on a 24V power source, a couple of distribution blocks, which make it easier to connect any other stuff that works on 24V; a custom made solenoid valve driver, an USB NiDAQ card from National Instruments and an Arduino due that is inside a 3D printed housing with a DIN rail clip attached. Each of these parts will be explained in detail below with instructions for assembly.</p> <figure><img src="/assets/img/control-1.31a5e2d2.png"> <center><figcaption><small>Control module.</small></figcaption></center></figure> <h2 id="solenoid-valve-driver-assembly"><a href="#solenoid-valve-driver-assembly" class="header-anchor">#</a> Solenoid valve driver assembly</h2> <figure><img src="/assets/img/control-assembly-1.3e1cb53a.png"></figure> <p>We designed a simple solenoid valve driver circuit using a MOSFET, the gate is driven by a digital input that will be supplied by the NIDAQ card, which open and closes the circuit from the solenoid valve to a 24V power supply. We added a diode to protect the circuit from discharge from the solenoid valve. To assembly the solenoid valve driver follow the next steps.</p> <ol><li>Have the PCB made (we use pcbway since they can make and ship the stencil, you can found our project <a href="https://www.pcbway.com/project/shareproject/Simple_Solenoid_valve_driver_1340eb55.html" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) and make sure to order a stencil. We use a manual printer for PCB stencil to spread the soldering paste across the PCB pads evenly. First, place the PCB on the surface using high temperature tape and place the stencil on top of it. Make sure to match the solder pads to the holes of the stencil.</li></ol> <figure><img src="/assets/img/control-assembly-2.e729353b.png"></figure> <ol start="2"><li>Use solder paste and a flexible wipe down knife and spread evenly the solder paste into the pads. Then lift and remove the stencil.</li></ol> <figure><img src="/assets/img/control-assembly-3.3c613198.png"></figure> <ol start="3"><li>Place each component into place, we place the resistances (R1, R3, R5, R7, and R9 resistor values are 10K Ohm and R2, R4, R6, R8 and R10 resistor values are 1K Ohm) first, then place the MOSFET and finally the diodes, make sure that the diodes are placed correctly (the band should match the ] symbol on the PCB). The picture below show the correct position of the components.</li></ol> <figure><img src="/assets/img/control-assembly-21.cd2c2b31.png"></figure> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Each time you place a component in the pad make sure to slightly press it against the solder paste with the same tweezers that you use.</p> <figure><img src="/assets/img/control-assembly-4.e9eb1fe1.png"></figure></div> <figure><img src="/assets/img/control-assembly-5.e85ae378.png"></figure> <ol start="4"><li>Use a heat gun (we set the temperature at 1000F) at the lowest intensity allowed (to avoid components flying around) and move it around on top of the components until the solder melt and the components get attached in place.</li></ol> <figure><img src="/assets/img/control-assembly-6.548f0cbf.png"></figure> <ol start="5"><li>Remove the high temperature tape and solder the pluggable terminal blocks, place the fillers and slide down the PCB into the case, then close the case.</li></ol> <figure><img src="/assets/img/control-assembly-7.516fd97f.png"></figure> <figure><img src="/assets/img/control-assembly-8.9f7e66aa.png"></figure> <figure><img src="/assets/img/control-assembly-9.5188fee4.png"></figure> <ol start="7"><li>Place the labels (make sure they are placed correctly) and place the driver on the DIN rail.</li></ol> <figure><img src="/assets/img/control-assembly-10.92ccf29e.png"></figure> <figure><img src="/assets/img/control-assembly-11.c0e33c40.png"></figure> <h2 id="power-supply-and-nidaq-control-assembly"><a href="#power-supply-and-nidaq-control-assembly" class="header-anchor">#</a> Power supply and NIDAQ control assembly</h2> <ol><li>Place the power supply and the distribution blocks on the DIN rails, connect the power supply to the distribution block input accordigly. The TRACO Power TBLC 50-124 is a 50W power supply, which is more than enough to power both the reward module solenoid valve (7 Watts) and the two air puffs solenoid valves (0.65 Watts each one), and have plenty of power left (~40W) for other modules if required. One power supply could be use for a stack of 2 or 3 rigs if desired.</li></ol> <figure><img src="/assets/img/control-assembly-12.e58faff5.png"></figure> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Use a standard PC power cable and cut the portion of the connector that goes to the PC, cut the ground cable and connect the neutral cable to the negative input of the power supply and the hot cable to the positive input.</p></div> <ol start="2"><li>Open the NIDAQ case and make a hole at the middle of the back case. Screw the DIN rail mounting clip to it, then close the case and place the top screws only.</li></ol> <figure><img src="/assets/img/control-assembly-13.17922eb1.png"></figure> <figure><img src="/assets/img/control-assembly-14.da4ce5ef.png"></figure> <ol start="3"><li>Connect everything!</li></ol> <ul><li>Start by connecting the positive output of the power supply from one of the pins of the red distribution blocks to the V IN input of the solenoid valve driver, then the ground from one of the pins of the black distribution block to the GND pin of the solenoid valve driver.</li> <li>Then connect the one of the GND pins of the solenoid valve driver to the the digital ground pin of the NIDAQ.</li> <li>Connect the solenoid valve driver inputs to the NIDAQ outputs as follows: P0.0 from NIDAQ to V IN 1, P0.1 to V IN 2 and P0.2 to V IN 3.</li> <li>Finally connect the solenoid valve driver outputs to the solenoid valve drivers. Since the solenoid valves doesn't have polarity, you should use the V OUT (+) as common in the valves, you can use one or multiple pins of the solenoid valve driver. Then connect the V OUT 1 (-) pin to the reward solenoid valve, the V OUT 2 (-) pin to the left solenoid valve and the V OUT 3 (-) to the right solenoid valve.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The solenoid valve driver has more outputs for you to connect and control with the NIDAQ digital outputs any other piece of hardware (like a 24 V IR light source for example), just make sure to wire the ports to the input and output of the driver and match them in the Rig Parameters portion of ViRMEN.</p></div> <figure><img src="/assets/img/control-assembly-15.9864fdac.png"> <center><figcaption><small>Control module wiring diagram for solenoid valves.</small></figcaption></center></figure> <h2 id="arduino-module-assembly"><a href="#arduino-module-assembly" class="header-anchor">#</a> Arduino module assembly</h2> <ol><li>Have printed the arduino case and screw the arduino. Insert the connector in place and crimp the cables. Make sure to follow the color code and connect the cables to the arduino.</li></ol> <figure><img src="/assets/img/control-assembly-16.d3892529.png"> <center><figcaption><small>Wiring diagram for Arduino due to connector.</small></figcaption></center></figure> <ol start="3"><li>Cover the case and install the din rail mounting clip. Install the arduino module in the top DIN rail.</li></ol> <figure><img src="/assets/img/control-assembly-17.167fb961.png"></figure> <ol start="4"><li>Make the cable to connect the arduino to the 3D printer cup. Unscrew the outer portion of the connector and insert it into the cable (you need to do this before connecting the cables, otherwise you will not be able to insert the cover and will have to do everything again). Unscrew all the conectors and insert the cable following the color code in the image below, screw them and place the connector cover.</li></ol> <figure><img src="/assets/img/control-assembly-18.e06b9945.png"></figure> <figure><img src="/assets/img/control-assembly-19.f1c2400d.png"></figure> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Place one connector first and connect it to the arduino box placed in the top DIN rail at the outer portion of the rig, then measure the lenght of the cable by inserting into the rig and into the cable carrier. Cut the cable and place the other connector, finally connect it to the 3D printed cup.</p></div> <ol start="5"><li>Connect the arduino to the computer using a <a href="https://www.bhphotovideo.com/c/product/1387544-REG/tether_tools_cuc2515_blk_tetherpro_usb_c_to_2_0.html?sts=pi&amp;pim=Y" target="_blank" rel="noopener noreferrer">USB Type-C male to micro-USB Type-B male cable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Or any other cable matching your setup, we do recommend to use a single tether cable or USB 3.0 cable and avoid using either multiple cables or HUBs (or make sure everything is high speed rated).</li></ol> <h2 id="programming-the-arduino"><a href="#programming-the-arduino" class="header-anchor">#</a> Programming the Arduino</h2> <ol><li><p>Download the latest version of the <a href="https://www.arduino.cc/en/software" target="_blank" rel="noopener noreferrer">arduino IDE<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and download the Arduino SAM Boards (32-bits ARM Cortex-M3) toolbox from the boards manager (Tools &gt; Boards &gt; Boards Manager), v1.6.11 has been working for us.</p></li> <li><p>Connect the arduino to the computer using the <a href="https://www.arduino.cc/en/uploads/Main/DueUSBPorts.jpg" target="_blank" rel="noopener noreferrer">Programming port<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (connect the cable to the USB port closest to the circular power connector). The arduino should be listed in the devices at the top of the window as <code>Arduino Due (Programming port)</code>.</p></li> <li><p>Either download or open from Matlab the firmware from the repository. The file is inside <strong>sensors &gt; ADNS_aout_wUSB_1sensor_or_squal_nativeport</strong> folder and is named <code>ADNS_aout_wUSB_1sensor_or_squal_nativeport.ino</code>. Make sure you have selecteed the board at the top of the window and upload the firmware by pressing the upload button (right arrow icon).</p></li> <li><p>Wait until the firmware is uploaded (a message in the terminal of the arduino IDE should confirm this) and disconnect the USB cable from the Programming port and connect it to the <a href="https://www.arduino.cc/en/uploads/Main/DueUSBPorts.jpg" target="_blank" rel="noopener noreferrer">Native Port<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The arduino should be programmed and working, you can confirm this by running the rig tester and pressing the <em>Arduino detection</em> and <em>sensor quality</em> buttons.</p></li></ol> <h2 id="usb-hub-and-speaker"><a href="#usb-hub-and-speaker" class="header-anchor">#</a> USB HUB and Speaker</h2> <ol><li>Use double side tape to glue the USB Hub to the cabinet at the top left portion above the DIN rail and connect everything that must be connected there (if using USB or USB powered speakers, the NIDAQ). Use a USB C extension to connect the hub to the computer.</li></ol> <figure><img src="/assets/img/control-assembly-20.edc1b377.png"></figure> <ol start="2"><li>Place the speaker inside the cabinet and connect to Hub - Make an upper hole on the cabinet for other cables as shown in the picture above. You can use a USB speakers or a desktop speakers and place them on top of the screen plate and connect it to the hub and, if necessary, to the computer audio input.</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/building/air-puffs.html" class="prev">
        Air puffs
      </a></span> <span class="next"><a href="/building/pupillometry.html">
        Pupillometry
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2e1d0086.js" defer></script><script src="/assets/js/2.f73e3e1e.js" defer></script><script src="/assets/js/1.c51b9512.js" defer></script><script src="/assets/js/12.01f9d7cf.js" defer></script>
  </body>
</html>
